<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Tu Profesor Experto - Academia Salvatumate</title>

  <script>
    window.MathJax = {
      tex: { 
        inlineMath: [["$", "$"], ["\\(", "\\)"]],
        displayMath: [["$$", "$$"], ["\\[", "\\]"]],
        processEscapes: true
      },
      svg: { fontCache: "global" },
      startup: { typeset: false }
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* ==============================
       VARIABLES & TEMA PRO
    ================================= */
    :root {
      --primary: #ef4444;
      --bg-body: #0f172a;
      --bg-card: #1e293b;
      --bg-input: #0f172a;
      --text-main: #f8fafc;
      --text-muted: #94a3b8;
      --accent: #f97316;
      --border: #334155;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: var(--bg-body);
      color: var(--text-main);
      min-height: 100vh;
      overflow-x: hidden;
    }
    
    .app-wrapper { max-width: 1250px; margin: 0 auto; padding: 1.5rem 1rem 4rem; width: 100%; }

    /* HEADER */
    .app-header { 
      display: flex; align-items: center; justify-content: space-between; 
      border-bottom: 1px solid var(--border); padding-bottom: 1.5rem; margin-bottom: 2rem; 
    }
    .logo-block { width: 80px; height: 80px; padding: 5px; }
    .logo-img { width: 100%; height: 100%; object-fit: contain; }
    .title-block { text-align: center; flex: 1; }
    .title-block h1 { font-size: 2rem; margin-bottom: 0.3rem; color: white; }
    .subtitle { color: var(--accent); font-weight: 700; font-size: 0.9rem; letter-spacing: 1px; }

    /* TABS */
    .tabs { display: flex; gap: 10px; margin-bottom: 2rem; background: #1e293b; padding: 10px; border-radius: 12px; }
    .tab-btn { flex: 1; padding: 12px; background: transparent; border: none; color: #94a3b8; cursor: pointer; font-weight: bold; border-radius: 8px; transition: 0.3s; }
    .tab-btn.active { background: var(--primary); color: white; }
    .tab-content { display: none; }
    .tab-content.active { display: block; animation: fadeIn 0.5s; }
    @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

    /* CARDS & FORMS */
    .card { background: var(--bg-card); border-radius: 1.2rem; padding: 2rem; margin-bottom: 1.5rem; border: 1px solid var(--border); }
    .card h2 { margin-bottom: 1.5rem; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
    
    .form-grid { display: grid; gap: 1.5rem; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); margin-bottom: 2rem; }
    .form-group label { display: block; margin-bottom: 0.5rem; color: var(--text-muted); font-size: 0.85rem; font-weight: bold; }
    select, input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-input); color: white; outline: none; }
    select:focus, input:focus { border-color: var(--primary); }

    /* BUTTONS */
    .primary-btn { background: var(--primary); color: white; padding: 15px; border-radius: 10px; border: none; cursor: pointer; font-weight: bold; width: 100%; text-transform: uppercase; letter-spacing: 1px; }
    .primary-btn:hover { background: #dc2626; }
    .secondary-btn { background: #334155; color: white; padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; }

    /* LAYOUT */
    .two-column { display: grid; grid-template-columns: 1.2fr 0.8fr; gap: 20px; }
    @media (max-width: 768px) { .two-column { grid-template-columns: 1fr; } .app-header { flex-direction: column; text-align: center; } }

    /* CAJAS RESULTADOS */
    .box { background: #0f172a; border: 1px solid var(--border); border-radius: 12px; padding: 20px; min-height: 150px; }
    .feedback-box.correct { border-color: #22c55e; background: rgba(34,197,94,0.1); }
    .feedback-box.incorrect { border-color: #ef4444; background: rgba(239,68,68,0.1); }

    /* TECLADO & PREVIEW */
    .keyboard-container { margin-top: 20px; background: #1e293b; border-radius: 10px; overflow: hidden; }
    .keyboard-tabs { display: flex; background: #0f172a; overflow-x: auto; }
    .kb-tab { flex: 1; padding: 10px; background: transparent; border: none; color: #aaa; cursor: pointer; border-right: 1px solid #333; }
    .kb-tab.active { background: #1e293b; color: var(--accent); font-weight: bold; }
    .keyboard-panel { display: none; padding: 10px; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); gap: 5px; }
    .keyboard-panel.active { display: grid; }
    .key-btn { background: #334155; color: white; border: 1px solid #444; height: 40px; border-radius: 6px; cursor: pointer; }
    .key-btn:active { background: var(--primary); }

    .math-preview-container { background: #000; border: 1px solid var(--accent); padding: 15px; border-radius: 8px; text-align: center; font-size: 1.5rem; min-height: 60px; margin: 10px 0; }

    /* PDF PREVIEW STYLES (PAPER) */
    #preview-container { background: #52525b; padding: 20px; border-radius: 10px; margin-top: 20px; max-height: 600px; overflow-y: auto; }
    #paper-view { 
        background: white; color: black; padding: 40px; margin: 0 auto; 
        max-width: 800px; min-height: 1000px; 
        font-family: 'Times New Roman', serif;
        box-shadow: 0 0 20px rgba(0,0,0,0.5);
    }

    /* LOADER */
    .loader { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>

<div class="app-wrapper">
  <header class="app-header">
    <div class="logo-block"><img src="logo-aprendamos.png" class="logo-img" onerror="this.style.display='none'"></div>
    <div class="title-block"><h1>Tu Profesor Experto</h1><p class="subtitle">ACADEMIA SALVATUMATE</p></div>
    <div class="logo-block"><img src="logo-salvatumate.png" class="logo-img" onerror="this.style.display='none'"></div>
  </header>

  <section class="tabs">
    <button class="tab-btn active" onclick="switchTab('ejercicio-unico')">Práctica</button>
    <button class="tab-btn" onclick="switchTab('explicaciones')">Explicaciones</button>
    <button class="tab-btn" onclick="switchTab('creador-tareas')">Tareas PDF</button>
  </section>

  <main>
    <section id="ejercicio-unico" class="tab-content active">
      <div class="card">
        <h2>Configura tu Práctica</h2>
        <div class="form-grid">
          <div class="form-group"><label>Materia</label><select id="materiaSelect" onchange="cargarTemas('materiaSelect','temaSelect','subtemaSelect')"><option value="">Seleccionar...</option></select></div>
          <div class="form-group"><label>Tema</label><select id="temaSelect" disabled onchange="cargarSubtemas('materiaSelect','temaSelect','subtemaSelect')"><option value="">Seleccionar...</option></select></div>
          <div class="form-group"><label>Subtema</label><select id="subtemaSelect" disabled><option value="">Seleccionar...</option></select></div>
          <div class="form-group"><label>Dificultad</label>
             <select id="nivelSelect">
                <option value="Básico">Básico</option>
                <option value="Intermedio" selected>Intermedio</option>
                <option value="Avanzado">Avanzado</option>
             </select>
          </div>
        </div>
        <button class="primary-btn" onclick="generarEjercicio()">GENERAR EJERCICIO</button>
      </div>

      <div class="two-column">
        <div class="column">
          <div class="card">
            <h3>Ejercicio</h3>
            <div id="ejercicioDisplay" class="box"></div>
            <div style="margin-top: 1rem;">
                <label>Tu Respuesta:</label>
                <div id="math-live-preview" class="math-preview-container">$$...$$</div>
                <input type="text" id="respuestaInput" placeholder="Escribe aquí (acepta LaTeX)..." oninput="updateMathPreview()">
                
                <div class="keyboard-container">
                    <div class="keyboard-tabs">
                       <button class="kb-tab active" onclick="switchKb('kb-1', this)">Básico</button>
                       <button class="kb-tab" onclick="switchKb('kb-2', this)">Álgebra</button>
                    </div>
                    <div id="kb-1" class="keyboard-panel active">
                       <button class="key-btn" onclick="insertLatex('+')">+</button>
                       <button class="key-btn" onclick="insertLatex('-')">-</button>
                       <button class="key-btn" onclick="insertLatex('\\cdot')">×</button>
                       <button class="key-btn" onclick="insertLatex('\\frac{}{}', 6)">÷</button>
                       <button class="key-btn" onclick="insertLatex('=')">=</button>
                       <button class="key-btn" onclick="insertLatex('\\sqrt{}', 6)">√</button>
                    </div>
                    <div id="kb-2" class="keyboard-panel">
                       <button class="key-btn" onclick="insertLatex('x')">x</button>
                       <button class="key-btn" onclick="insertLatex('y')">y</button>
                       <button class="key-btn" onclick="insertLatex('^2')">²</button>
                       <button class="key-btn" onclick="insertLatex('^{}', 2)">^n</button>
                    </div>
                </div>

                <div style="display:flex; gap:10px; margin-top:15px;">
                    <button class="secondary-btn" onclick="verificarRespuesta()">Comprobar</button>
                    <button class="secondary-btn" style="background:#444;" onclick="document.getElementById('respuestaInput').value='';updateMathPreview()">Borrar</button>
                </div>
            </div>
          </div>
        </div>
        <div class="column">
          <div class="card">
             <h3>Retroalimentación</h3>
             <div id="feedbackDisplay" class="box"></div>
          </div>
          <div class="card">
             <h3>Tutor IA</h3>
             <div id="chatDisplay" class="box" style="height:300px; overflow-y:auto; display:flex; flex-direction:column; gap:10px;"></div>
             <div style="display:flex; gap:5px; margin-top:10px;">
                <input type="text" id="chatInput" placeholder="Pregunta algo...">
                <button class="secondary-btn" onclick="enviarChat()">Enviar</button>
             </div>
          </div>
        </div>
      </div>
    </section>

    <section id="explicaciones" class="tab-content">
       <div class="card">
           <h2>Clase Magistral</h2>
           <input type="text" id="temaLeccion" placeholder="Tema (ej. Derivadas)">
           <button class="primary-btn" style="margin-top:10px;" onclick="generarLeccionIA()">Explicar Tema</button>
           <div id="lessonContainer" style="margin-top:20px;"></div>
       </div>
    </section>

    <section id="creador-tareas" class="tab-content">
      <div class="card">
        <h2>Generador de Tareas PDF</h2>
        <div class="form-grid">
          <div class="form-group"><label>Materia</label><select id="tareaMateria" onchange="cargarTemas('tareaMateria','tareaTema', 'tareaSubtema')"><option value="">Seleccionar...</option></select></div>
          <div class="form-group"><label>Tema</label><select id="tareaTema" disabled onchange="cargarSubtemas('tareaMateria', 'tareaTema', 'tareaSubtema')"><option value="">Seleccionar...</option></select></div>
          <div class="form-group"><label>Subtema</label><select id="tareaSubtema" disabled><option value="">Seleccionar...</option></select></div>
          <div class="form-group"><label>Nivel</label><select id="tareaNivel"><option value="Básico">Básico</option><option value="Intermedio">Intermedio</option><option value="Avanzado">Avanzado</option></select></div>
          <div class="form-group"><label>Cantidad</label><input type="number" id="tareaCantidad" value="5" min="1" max="20"></div>
        </div>
        <div style="display:flex; gap:10px;">
          <button class="primary-btn" onclick="generarVistaPreviaPDF()">Generar Vista Previa</button>
          <button class="secondary-btn" id="btnDescargar" onclick="descargarPDF()" disabled>Descargar PDF</button>
        </div>
      </div>
      <div id="preview-container">
          <div id="paper-view">La vista previa aparecerá aquí...</div>
      </div>
    </section>

  </main>
</div>

<script>
  // DATOS
  const TEMARIOS = {
    "Aritmética": {
      "Operaciones": ["Suma/Resta", "Multiplicación/División", "Jerarquía"],
      "Fracciones": ["Suma/Resta", "Mixtas", "Simplificación"],
      "Porcentajes": ["Cálculo base", "Descuentos", "Interés Simple"]
    },
    "Álgebra": {
      "Expresiones algebraicas": ["Términos, coeficientes y grado", "Valor numérico", "Lenguaje algebraico"],
      "Polinomios": ["Suma y Resta", "Multiplicación", "Productos Notables"],
      "Ecuaciones": ["Lineales 1 var", "Sistemas 2x2", "Cuadráticas"],
      "Factorización": ["Factor Común", "Diferencia Cuadrados", "Trinomios"]
    },
    "Geometría": {
      "Ángulos": ["Tipos", "Operaciones", "Entre paralelas"],
      "Triángulos": ["Pitágoras", "Área y Perímetro", "Semejanza"],
      "Círculo": ["Área", "Perímetro", "Sectores"]
    },
    "Trigonometría": {
      "Razones": ["Seno, Coseno, Tangente", "Triángulos Rectángulos"],
      "Identidades": ["Pitagóricas", "Recíprocas"],
      "Leyes": ["Ley Senos", "Ley Cosenos"]
    },
    "Cálculo Diferencial": {
      "Límites": ["Directos", "Indeterminados", "Al infinito"],
      "Derivadas": ["Reglas básicas", "Regla Cadena", "Implícita"]
    },
    "Cálculo Integral": {
      "Integrales": ["Inmediatas", "Sustitución", "Por Partes", "Definidas"]
    }
  };

  window.onload = () => {
    llenarSelect("materiaSelect", Object.keys(TEMARIOS));
    llenarSelect("tareaMateria", Object.keys(TEMARIOS));
  };

  // UI HELPERS
  function switchTab(id) {
      document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(e => e.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      event.target.classList.add('active');
  }
  function switchKb(id, btn) {
      document.querySelectorAll('.keyboard-panel').forEach(e => e.classList.remove('active'));
      document.querySelectorAll('.kb-tab').forEach(e => e.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      btn.classList.add('active');
  }

  // SELECTS LOGIC
  function llenarSelect(id, arr) {
    const s = document.getElementById(id); s.innerHTML = '<option value="">Seleccionar...</option>';
    arr.forEach(x => { let o = document.createElement("option"); o.value = x; o.text = x; s.add(o); });
  }
  function cargarTemas(idM, idT, idS) {
    const m = document.getElementById(idM).value; 
    const t = document.getElementById(idT);
    t.innerHTML = '<option value="">Seleccionar...</option>'; t.disabled = !m;
    document.getElementById(idS).innerHTML='<option value="">Seleccionar...</option>'; document.getElementById(idS).disabled=true;
    if(m && TEMARIOS[m]) llenarSelect(idT, Object.keys(TEMARIOS[m]));
  }
  function cargarSubtemas(idM, idT, idS) {
    const m = document.getElementById(idM).value, t = document.getElementById(idT).value, s = document.getElementById(idS);
    s.innerHTML = '<option value="">Seleccionar...</option>'; s.disabled = !t;
    if(m && t && TEMARIOS[m][t]) llenarSelect(idS, TEMARIOS[m][t]);
  }

  // MATHJAX PREVIEW
  function insertLatex(txt, back=0) {
      const el = document.getElementById('respuestaInput');
      const start = el.selectionStart; 
      el.value = el.value.substring(0, start) + txt + el.value.substring(el.selectionEnd);
      el.focus(); el.selectionEnd = start + txt.length - back;
      updateMathPreview();
  }
  function updateMathPreview() {
      const val = document.getElementById('respuestaInput').value;
      const box = document.getElementById('math-live-preview');
      box.innerHTML = val ? `$$${val}$$` : '$$...$$';
      MathJax.typesetPromise([box]);
  }

  // --- API CALL ---
  async function callGemini(prompt, json=false) {
      const url = "/api/gemini"; 
      try {
          const r = await fetch(url, {
            method: "POST", 
            headers: {"Content-Type":"application/json"}, 
            body: JSON.stringify({ prompt, json })
          });
          const d = await r.json();
          if(d.error) throw d.error;
          let txt = d.candidates?.[0]?.content?.parts?.[0]?.text;
          if(json) txt = txt.replace(/```json/g, "").replace(/```/g, "").trim();
          return json ? JSON.parse(txt) : txt;
      } catch(e) { 
          alert("Error: " + (e.message || e)); 
          throw e; 
      }
  }

  // --- LOGIC: EJERCICIO UNICO ---
  let ejercicioActual = null;
  async function generarEjercicio() {
      const m=document.getElementById("materiaSelect").value;
      const t=document.getElementById("temaSelect").value;
      const s=document.getElementById("subtemaSelect").value;
      const n=document.getElementById("nivelSelect").value;

      if(!m || !t) return alert("Selecciona Materia y Tema");
      
      document.getElementById("ejercicioDisplay").innerHTML = '<div class="loader"></div>';
      
      const prompt = `Genera 1 ejercicio matemático de: ${m} > ${t} > ${s}. Nivel: ${n}. 
      Formato JSON: { "enunciado": "Usar LaTeX $$...$$", "respuesta": "Solución" }`;

      try {
          const data = await callGemini(prompt, true);
          ejercicioActual = data;
          const box = document.getElementById("ejercicioDisplay");
          box.innerHTML = `<p style="font-size:1.2rem;">${data.enunciado}</p>`;
          MathJax.typesetPromise([box]);
      } catch(e) { document.getElementById("ejercicioDisplay").innerHTML = "Error."; }
  }

  async function verificarRespuesta() {
      if(!ejercicioActual) return;
      const u = document.getElementById("respuestaInput").value;
      const box = document.getElementById("feedbackDisplay");
      box.innerHTML = '<div class="loader"></div>';

      const prompt = `Evalúa si "${u}" es equivalente a la respuesta correcta "${ejercicioActual.respuesta}".
      JSON: { "esCorrecto": bool, "mensaje": "Breve feedback", "explicacion": "Breve explicación LaTeX" }`;

      try {
          const r = await callGemini(prompt, true);
          box.className = `box feedback-box ${r.esCorrecto?'correct':'incorrect'}`;
          box.innerHTML = `<strong>${r.mensaje}</strong><br>${r.explicacion}`;
          MathJax.typesetPromise([box]);
      } catch(e) { box.innerHTML = "Error."; }
  }

  // --- LOGIC: TAREAS PDF (SOLUCIÓN ABSOLUTA) ---
  async function generarVistaPreviaPDF() {
      // 1. CAPTURAR VALORES DEL SELECTOR
      const m = document.getElementById("tareaMateria").value;
      const t = document.getElementById("tareaTema").value;
      const s = document.getElementById("tareaSubtema").value;
      const n = document.getElementById("tareaNivel").value;
      const c = parseInt(document.getElementById("tareaCantidad").value);

      // 2. VALIDACIÓN ESTRICTA: Si no hay tema, alerta y para.
      if(!m || !t || t === "Seleccionar...") {
          return alert("⚠️ ERROR: Debes seleccionar una Materia y un Tema antes de generar.");
      }

      const viewer = document.getElementById("paper-view");
      viewer.innerHTML = '<div style="text-align:center; padding:50px;"><div class="loader" style="border-color:#333; border-top-color:transparent;"></div><br>Generando examen personalizado...</div>';

      // 3. PROMPT "SOLO DATOS"
      // Le pedimos un par de ejercicios extra (c + 2) por seguridad, pero el código solo usará 'c'.
      // NO le pedimos título a la IA.
      const prompt = `
        Actúa como generador de datos matemáticos.
        Genera EXACTAMENTE ${c + 1} ejercicios del tema: "${m} - ${t} (${s})".
        Nivel: ${n}.
        
        SOLO JSON CON ARRAY DE STRINGS. NADA MÁS.
        Formato:
        {
           "preguntas": ["LaTeX ejercicio 1", "LaTeX ejercicio 2", ...],
           "respuestas": ["Resp 1", "Resp 2", ...]
        }
      `;

      try {
          const data = await callGemini(prompt, true);
          
          // 4. CONSTRUCCIÓN FORZADA DEL TÍTULO Y CORTE DE EJERCICIOS
          // Aquí es donde nosotros tenemos el control total.
          
          const tituloOficial = `TAREA: ${t.toUpperCase()} - Academia Salva tu Mate`;
          const subtituloOficial = `Materia: ${m} | Subtema: ${s || "General"} | Nivel: ${n} | Cantidad: ${c}`;

          let html = `
            <div style="border-bottom: 3px solid #000; padding-bottom: 10px; margin-bottom: 30px; text-align: center;">
                <h1 style="margin: 0; font-size: 22px; text-transform: uppercase;">${tituloOficial}</h1>
                <p style="margin: 5px 0 0; color: #555; font-size: 14px;">${subtituloOficial}</p>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 30px; font-size: 14px;">
                <span><strong>Alumno:</strong> ___________________________________________</span>
                <span><strong>Fecha:</strong> _______________</span>
            </div>

            <div style="margin-bottom: 20px;">
                <h3 style="border-bottom: 1px solid #ccc; padding-bottom: 5px;">Ejercicios</h3>
          `;

          // 5. RENDERIZAR EXACTAMENTE 'C' PREGUNTAS
          if(data.preguntas && Array.isArray(data.preguntas)) {
              // Usamos un loop for simple para asegurar el límite 'c'
              for(let i = 0; i < c; i++) {
                  // Verificamos si la pregunta existe (por si la IA generó menos)
                  if(data.preguntas[i]) {
                      html += `
                        <div style="margin-bottom: 25px; page-break-inside: avoid;">
                            <div style="font-weight: bold; margin-bottom: 8px;">${i+1}. ${data.preguntas[i]}</div>
                            <div style="height: 80px; border: 1px dashed #eee; width: 100%;"></div> 
                        </div>
                      `;
                  }
              }
          }

          // HOJA DE RESPUESTAS
          html += `</div><div class="html2pdf__page-break"></div>
                   <div style="text-align: center; margin-bottom: 20px;">
                      <h2>Hoja de Respuestas</h2>
                      <p style="color:#666;">Solo para uso del profesor</p>
                   </div>
                   <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">`;

          if(data.respuestas && Array.isArray(data.respuestas)) {
              for(let i = 0; i < c; i++) {
                  if(data.respuestas[i]) {
                     html += `<div style="border: 1px solid #ddd; padding: 10px; border-radius: 4px;">
                                <strong>${i+1}:</strong> ${data.respuestas[i]}
                              </div>`;
                  }
              }
          }
          html += `</div>`;

          viewer.innerHTML = html;
          MathJax.typesetPromise([viewer]);
          document.getElementById("btnDescargar").disabled = false;

      } catch(e) {
          console.error(e);
          viewer.innerHTML = '<p style="color:red; text-align:center;">Error al generar. Por favor intenta de nuevo.</p>';
      }
  }

  function descargarPDF() {
      const element = document.getElementById('paper-view');
      const opt = {
          margin: 0.5,
          filename: 'Tarea_Salvatumate.pdf',
          image: { type: 'jpeg', quality: 0.98 },
          html2canvas: { scale: 2 },
          jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
      };
      html2pdf().set(opt).from(element).save();
  }

  // CHAT
  async function enviarChat() {
     const i = document.getElementById("chatInput");
     const txt = i.value; if(!txt) return;
     const area = document.getElementById("chatDisplay");
     area.innerHTML += `<div style="text-align:right; margin:5px;"><span style="background:#ef4444; color:white; padding:5px 10px; border-radius:10px;">${txt}</span></div>`;
     i.value = "";
     try {
         const r = await callGemini("Eres tutor. Responde breve: " + txt, false);
         area.innerHTML += `<div style="text-align:left; margin:5px;"><span style="background:#334155; padding:5px 10px; border-radius:10px;">${r}</span></div>`;
         area.scrollTop = area.scrollHeight;
     } catch(e){}
  }
</script>
</body>
</html>